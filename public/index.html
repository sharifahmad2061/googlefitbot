<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta
			name="google-signin-client_id"
			content="302313684265-0knsk18lfbeklpp2sqab95a0ta491qva.apps.googleusercontent.com"
		/>
		<title>Welcome to Firebase Hosting</title>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script src="https://apis.google.com/js/platform.js"></script>
		<script src="https://apis.google.com/js/api.js"></script>
	</head>
	<body>
		<div class="g-signin2" data-onsuccess="onSignIn"></div>
		<div><button class="signout">Sign Out</button></div>
		<script>
			document.addEventListener('DOMContentLoaded', function() {
				console.log('hello')
				function onSignIn(googleUser) {
					console.log('I am called')
					const firestore = firebase.firestore()
					const usersDb = firestore.collection('users')
					const idToken = googleUser.getAuthResponse().id_token
					const profile = googleUser.getBasicProfile()
					const userid = profile.getId()
					const name = profile.getName()
					const email = profile.getEmail()
					console.log(usersDb)
					usersDb
						.doc(userid)
						.set({
							name: name,
							email: email,
							idtoken: idToken
						})
						.then(function() {
							console.log('user successfully written to db')
							if (
								googleUser.hasGrantedScopes(
									'https://www.googleapis.com/auth/fitness.activity.read'
								)
							) {
								console.log('has granted')
							} else {
								googleUser
									.grant({
										scope:
											'https://www.googleapis.com/auth/fitness.activity.read'
									})
									.then(function() {
										console.log('now granted')
										// $.getJSON(
										// 	'https://www.googleapis.com/fitness/v1/users/me/sessions',
										// 	function(res) {
										// 		console.log(JSON.parse(res))
										// 	}
										// )
										$.ajax({
											url:
												'https://www.googleapis.com/fitness/v1/users/userId/dataSources',
											success: function(res) {
												console.log(JSON.parse(res))
											}
										}).fail(function(err) {
											console.log(err)
										})
									})
							}
						})
						.catch(function(error) {
							console.log(error)
						})
				}
				const signoutbtn = $('.signout')
				signoutbtn.click(event => {
					signout()
				})
				function signout() {
					const auth2 = gapi.auth2.getAuthInstance()
					auth2
						.signOut()
						.then(() => {
							console.log('user signed out')
						})
						.catch(err => {
							console.log(err)
						})
				}
			})
		</script>
		<!-- update the version number as needed -->
		<script defer src="/__/firebase/7.11.0/firebase-app.js"></script>
		<!-- include only the Firebase features as you need -->
		<script defer src="/__/firebase/7.11.0/firebase-firestore.js"></script>
		<!-- initialize the SDK after all desired features are loaded -->
		<script defer src="/__/firebase/init.js"></script>
	</body>
</html>
